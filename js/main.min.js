let stage, canvas, context, sphere, width, height, scene, camera, renderer, element, controls,
    images = [], imglen, arrows = [],　fixedposi = [], cur, mwidth, mheight, floor, hrate,
    callbackdraw, callbackrender, mypro, prospa, stsvg, minibutton, mapz = 0.6, mapas = 0.65,
    target_meta, view_cnt = 0, spot = -1, mode = 1*(-1), high, modep_cnt = [0,0], rotate_flag = true,
    pre_elem, user_ios;

const posi = [
    [57.8,21.6,1,2], //0
    [66.9,21.6,1,2],
    [77.5,21.6,1,2],
    [77.5,31.7,1,2],
    [66.9,31.7,1,2],
    [57.8,31.7,1,2], //5
    [42.3,31.7,1,2],
    [24.2,31.7,1,2],
    [7.4 ,31.7,1,2],
    [7.4 ,48.6,1,2],
    [7.4 ,74.1,1,2], //10
    [7.4 ,88.4,1,2],
    [24.4,88.4,1,2],
    [42.3,88.4,1,2],
    [67.0,88.4,1,2],
    [77.5,88.4,1,2], //15
    [77.5,74.0,1,2],
    [77.5,48.6,1,2],
    [42.3,48.6,1,2],
    [42.3,74.1,1,2],
// ↑__ west_2F
    [77.5,21.6,0,1], //20
    [66.9,21.6,0,1],
    [57.8,21.6,0,2],
    [57.8,31.7,0,1],
    [66.9,31.7,0,1],
    [66.9,26.5,0,1], //25
    [77.5,31.7,0,1],
    [42.3,31.7,0,2],
    [24.2,31.7,0,2],
    [7.4 ,31.7,0,2],
    [7.4 ,48.6,0,2], //30
    [7.4 ,74.1,0,2],
    [7.4 ,88.3,0,2],
    [24.2,88.3,0,1],
    [42.3,88.3,0,2],
    [42.3,74.1,0,2], //35
    [42.3,48.9,0,2],
    [61.7,88.3,0,1],
    [77.5,88.3,0,1],
// ↑__ west_1F
    [74.0,123.6,0,2],
    [68.0,123.6,0,2], //40
    [68.0,138.2,0,1],
    [87.4,138.2,0,1],
    [87.4,152.9,0,1],
    [87.4,164.9,0,1],
    [82.6,171.8,0,1], //45
    [82.6,186.5,0,1],
    [61.3,171.8,0,1],
    [42.9,171.8,0,1],
    [47.6,138.2,0,1],
    [32.3,138.2,0,1], //50
    [32.3,118.7,0,1],
    [12.6,138.2,0,1],
    [12.6,145.0,0,1],
    [12.6,160.6,0,1],
    [12.6,143.6,1,1], //55
    [12.6,151.1,1,1],
    [12.6,160.1,1,1],
    [77.1,152.9,0,1],
    [41.2,186.5,0,1],
    [50.2,125.0,1,1], //60
    [82.2 ,96.8,1,1],  //bridge
    [82.5,101.7,0,1], //bridge
    [68.0,118.1,0,1],
    [61.3,186.5,0,1],
    [37.7,125.0,1,1], //65
// ↑__ east
    [88.1 ,21.6,-1,-1], //0
    [46.7 ,34.7,-1,-1],
    [11.8 ,34.7,-1,-1],
    [10.6 ,91.4,-1,-1],
    [45.5 ,91.4,-1,-1],     //70
    [80.7 ,91.4,-1,-1], //5
    [72.4,118.1,-1,-1],
    [27.1,114.2,-1,-1],
    [6.6 ,147.2,-1,-1],
    [150 ,115.5,-1,-1]
// ↑__ dummy
];

const dummy=10,num=posi.length-10;let double=0;const connect=[[0,1],[1,2],[2,num],[2,3],[3,4],[4,5],[5,0],[5,6],[6,num+1],[6,7],[7,8],[8,num+2],[8,9],[9,10],[10,11],[11,num+3],[11,12],[12,13],[13,num+4],[13,19],[19,18],[6,18],[13,14],[14,61],[14,15],[15,num+5],[15,16],[16,17],[3,17],[20,num],[20,21],[21,22],[22,23],[23,24],[24,26],[26,20],[20,25],[21,25],[22,25],[23,25],[24,25],[26,25],[23,27],[27,num+1],[27,28],[28,29],[29,30],[29,num+2],[30,31],[31,32],[32,num+3],[32,33],[33,34],[34,num+4],[34,35],[35,36],[36,27],[34,37],[37,38],[38,num+5],[39,40],[39,num+9],[40,63],[63,num+6],[60,num+6],[60,65],[40,41],[41,42],[41,58],[42,43],[43,44],[44,45],[45,46],[45,47],[47,48],[47,64],[46,64],[48,59],[41,49],/*[49,50]*/,[50,51],[51,num+7],/*[65,num+7]*/,[50,52],[52,53],[53,54],[53,num+8],[56,num+8],[56,55],[56,57],[61,62],[62,num+9],[64,59]];let map=new Array(posi.length);for(let e=0;e<posi.length;++e)map[e]=new Array;connect.forEach(e=>{map[e[0]].push(e[1]),map[e[1]].push(e[0])});let layer=[[[],[]],[[],[],[]]];const complaints_from_a_monkey=[50,51,52,53,54,55,56,57];for(let e=0;e<posi.length;++e){if(complaints_from_a_monkey.includes(e))continue;let t=0;-1!=posi[e][2]&&(posi[e][1]>100&&t++,layer[t][posi[e][2]].push([posi[e][0],posi[e][1],e]),1!=posi[e][3]&&double++)}const query=location.search,val=location.search.split("=");function pre_click(e,t){const n=new THREE.Vector2;n.x=e/width*2-1,n.y=-t/height*2+1;const o=new THREE.Raycaster;o.setFromCamera(n,camera);const i=o.intersectObjects(scene.children);pre_elem=i[0].object.name}function click(e,t){const n=new THREE.Vector2;n.x=e/width*2-1,n.y=-t/height*2+1;const o=new THREE.Raycaster;o.setFromCamera(n,camera);const i=o.intersectObjects(scene.children);if(null!=i[0].object.name&&i[0].object.name==pre_elem){let e=i[0].object.name;if(-1==posi[Number(e)][2]){e=map[e][0]!=cur?map[e][0]:map[e][1];const t=i[0].object.rotation.y/Math.PI;.25<=t&&t<=.75||1.25<=t&&t<=1.75?camera.position.x*=-1:camera.position.z*=-1}move(e)}}function move(e){sphere.material.map=images[e][(mode+1)*(posi[e][3]-1)/2],sphere.material.needsUpdate=!0,cur=e,floor=posi[e][2],arrows.forEach(e=>{scene.remove(e)}),generateArrows(e),cancelAnimationFrame(callbackdraw),draw(),mini_button(e)}function draw(){callbackdraw=requestAnimationFrame(draw);let e=.01*posi[cur][1],t=.01*posi[cur][0],n=images[num+1+floor+2*Math.floor(e)];e=Math.floor(e)+1-e,context.fillStyle="rgb(245,245,245)",context.fillRect(0,0,mwidth,mheight);let o=1e3*mapz,i=1e3*mapz*mapas,a=Math.max(1500*e-.5*o,0),s=Math.max(1e3*t-.5*i,0),r=Math.min(1500*e-.5*o,0)+1e3*mapz,m=(Math.min(1e3*t-.5*i,0)+1e3*mapz)*mapas;r-=Math.max(a+r-1500,0),m-=Math.max(s+m-1e3,0);let c=Math.max(-(1500*e-.5*o)*mwidth/o,0),l=Math.max(-(1e3*t-.5*i)*mheight/i,0),d=r*mwidth/o,u=m*mheight/i;context.drawImage(n,a,s,r,m,c,l,d,u);const g=posi_to_theta(camera.position.z,-camera.position.x);context.translate(.5*mwidth,.5*mheight),context.rotate(-g),context.drawImage(images[num+imglen],0,0,128,128,.17*-mwidth*mapas,.17*-mheight,.34*mwidth*mapas,.34*mheight),context.rotate(g),context.translate(.5*-mwidth,.5*-mheight)}function mini_button(e){null!=minibutton&&minibutton.remove();let t=Math.floor(posi[cur][1]/100);posi[cur][1],posi[cur][0];document.getElementById("container").insertAdjacentHTML("afterbegin",`<svg viewBox="0 0 ${100*mapz} ${100*mapz*mapas}" width="100%" height="100%" id="minibutton"></svg>`),minibutton=document.getElementById("minibutton"),minibutton.style.width=`${height*hrate}px`,minibutton.style.height=`${height*hrate*mapas}px`,layer[t][floor].forEach(e=>{let n=50*mapz+1.5*(posi[cur][1]-100*t-(e[1]-100*t)),o=50*mapz*mapas+e[0]-posi[cur][0];minibutton.insertAdjacentHTML("beforeend",`<rect id="mini${e[2]}" x="${n-1.6}" y="${o-1.6}" width="3.2" height="3.2"\n         fill="rgb(192,226,247)" onclick="move(${e[2]})"/>`)}),document.getElementById(`mini${e}`).remove()}function posi_to_theta(e,t){let n;return e*=-1,0==(t*=-1)?n=e>=0?Math.PI/2:3*Math.PI/2:(n=Math.atan(e/t),n+=n*e<0||0==n&&t<0?Math.PI:2*Math.PI),n}function generateArrows(e){const t=new THREE.BoxGeometry(.5,0,.5),n=new THREE.MeshBasicMaterial({map:images[num],transparent:!0});arrows=[],fixedposi=[];for(let o=0;o<map[e].length;++o){let i=new THREE.Mesh(t,n);i.name=map[e][o],arrows.push(i);let a=posi[map[e][o]][0]-posi[e][0],s=posi[map[e][o]][1]-posi[e][1],r=.75;fixedposi.push([a*Math.sqrt(r*r/(a*a+s*s)),s*Math.sqrt(r*r/(a*a+s*s))]),i.rotation.y=posi_to_theta(a,s),scene.add(i)}}function better_view(){let e,t;function n(){width>=height?high=30:high=20,1==view_cnt?(minimap.style.display="none",minibutton.style.display="none",arrows.forEach(e=>{scene.remove(e)}),document.getElementById("menubar").style.top="calc(-13vmin - 6px)",document.getElementById("spotviewer").style.top=`-${high}%`,document.getElementById("container").insertAdjacentHTML("afterbegin","<div id='showb' onclick='better_view()'><div id='showbv'></div></div>"),e=document.getElementById("showb"),t=document.getElementById("showbv"),setTimeout(i,20),element.addEventListener("touchstart",o,{passive:!0}),element.addEventListener("touchend",i,{passive:!0}),element.addEventListener("mousedown",o,{passive:!0}),element.addEventListener("mouseup",i,{passive:!0}),view_cnt*=-1):(minimap.style.display="block",minibutton.style.display="block",arrows.forEach(e=>{scene.add(e)}),document.getElementById("menubar").style.top="4px",document.getElementById("showb").remove(),document.fullscreenElement&&(document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen()),element.removeEventListener("touchstart",o,{passive:!0}),element.removeEventListener("touchend",i,{passive:!0}),element.removeEventListener("mousedown",o,{passive:!0}),element.removeEventListener("mouseup",i,{passive:!0}),view_cnt++)}function o(){e.style.transition="all 0.1s cubic-bezier(0.55, 0.06, 0.68, 0.19)",t.style.transition="all 0.1s cubic-bezier(0.55, 0.06, 0.68, 0.19)",e.style.backgroundColor="rgba(255, 255, 255, .6)",width>=height?(t.style.borderBottom=".8vmin solid rgb(255, 255, 255, 0.9)",t.style.borderRight=".8vmin solid rgb(255, 255, 255, 0.9)"):(t.style.borderBottom="1.3vw solid rgb(255, 255, 255, 0.9)",t.style.borderRight="1.3vw solid rgb(255, 255, 255, 0.9)")}function i(){e.style.transition="all 3s cubic-bezier(0.55, 0.06, 0.68, 0.19)",t.style.transition="all 3s cubic-bezier(0.55, 0.06, 0.68, 0.19)",e.style.backgroundColor="rgba(255, 255, 255, .0)",width>=height?(t.style.borderBottom=".8vmin solid rgb(255, 255, 255, .0)",t.style.borderRight=".8vmin solid rgb(255, 255, 255, .0)"):(t.style.borderBottom="1.3vw solid rgb(255, 255, 255, .0)",t.style.borderRight="1.3vw solid rgb(255, 255, 255, .0)")}0!=view_cnt?n():(view_cnt++,user_ios?n():document.fullscreenEnabled?document.getElementById("container").requestFullscreen():document.webkitFullscreenEnabled?document.getElementById("container").webkitRequestFullscreen():document.mozFullScreenEnabled?document.getElementById("container").mozRequestFullScreen():document.msFullscreenEnabled?document.getElementById("container").msRequestFullscreen():n())}function spotSerect(){width>=height?high=30:high=20,-1==spot?(document.getElementById("spotviewer").style.top="0",document.getElementById("menubar").style.top=`calc(${high}% + 4px)`,document.getElementById("menub").style.transform="rotate(-135deg)"):(document.getElementById("spotviewer").style.top=`-${high}%`,document.getElementById("menubar").style.top="4px",document.getElementById("menub").style.transform="rotate(0deg)"),spot*=-1}async function change_mode(){mode*=-1;const e=document.getElementById("mode"),t=document.querySelector(".modep"),n=e=>new Promise(t=>setTimeout(t,e));-1===mode?t.innerHTML="通常モード":t.innerHTML="音展モード",sphere.material.map=images[cur][(mode+1)*(posi[cur][3]-1)/2],sphere.material.needsUpdate=!0,(async()=>{rotate_flag||(rotate_flag=!0,e.style.transition="all .5s",e.style.transform="rotate(-180deg)",await n(500),e.style.transition="all .0s",e.style.transform="rotate(0deg)",rotate_flag=!1)})(),0==modep_cnt[0]&&(t.style.display=""),modep_cnt[0]++,modep_cnt[1]++,await n(100),t.classList.add("show"),await n(1500),1==modep_cnt[1]&&t.classList.remove("show"),modep_cnt[1]--,await n(1e3),1==modep_cnt[0]&&(t.style.display="none"),modep_cnt[0]--}function handleResize(){width=window.innerWidth,height=window.innerHeight,width>=height?(hrate=.31,high=30,.9!=mapz&&(mapz=.9,-1!=view_cnt&&mini_button(cur))):(hrate=.21,high=20,.6!=mapz&&(mapz=.6,-1!=view_cnt&&mini_button(cur))),canvas.width=`${height*hrate}`,canvas.height=`${canvas.width*mapas}`,mwidth=canvas.width,mheight=canvas.height,minibutton.style.width=`${height*hrate}px`,minibutton.style.height=`${height*hrate*mapas}px`,document.getElementById("spotviewer").style.height=`${high}%`,-1==view_cnt?(document.getElementById("menubar").style.top=`-${high}%`,document.getElementById("spotviewer").style.top=`-${high}%`):(document.getElementById("menubar").style.top=`calc(${(spot+1)*high*.5}% + 4px)`,document.getElementById("spotviewer").style.top=`${(spot-1)*high*.5}%`),renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(width,height),camera.aspect=width/height,camera.updateProjectionMatrix()}function setOrbitControls(){controls=new THREE.OrbitControls(camera,element),controls.target.set(0,0,0),controls.enableDamping=!0,controls.enableZoom=!1,controls.enablePan=!1,controls.dampingFactor=.15,controls.rotateSpeed=-.06}function render(){callbackrender=requestAnimationFrame(render),renderer.render(scene,camera),controls.update();let e=camera.position.x,t=camera.position.z;e*=-1,t*=-1;for(let n=0;n<arrows.length;++n)arrows[n].position.set(15*e+fixedposi[n][0],-1.3-.001*n,15*t+fixedposi[n][1])}function del(){cancelAnimationFrame(callbackdraw),cancelAnimationFrame(callbackrender),arrows=[],stage.remove(),canvas.remove(),minibutton.remove(),document.getElementById("delb").remove(),document.getElementById("menub").remove(),document.getElementById("menubar").remove(),document.getElementById("spotviewer").remove(),history.back()}window.onload=(()=>{const e=decodeURIComponent(val[1]);if(e<0||(50<=e&&e<=57)||e>=num)return void document.body.insertAdjacentHTML("afterbegin","<p>Error: number out of range</p>");document.getElementById("container").insertAdjacentHTML("afterbegin","<div id='stage'></div>"),stage=document.getElementById("stage");const t=Math.floor(Math.random()*num);stage.style.backgroundImage=`url(images/image${t}-${Math.floor(Math.random()*posi[t][3])}.JPG)`;const n=["images/Koyo-East-text-1.png","images/Koyo-East-text-2.png","images/Koyo-West-text-1.png","images/Koyo-West-text-2.png","images/blue_arrow.png"];imglen=n.length;let o=0;function i(){width=stage.clientWidth,height=stage.clientHeight,scene=new THREE.Scene,camera=new THREE.PerspectiveCamera(75,width/height,.5,9),camera.position.set(.1,0,0),scene.add(camera);const t=new THREE.SphereGeometry(8,64,64);t.scale(-1,1,1);const n=new THREE.MeshBasicMaterial({map:images[e][(mode+1)*(posi[e][3]-1)/2]});sphere=new THREE.Mesh(t,n),sphere.name=void 0,scene.add(sphere),cur=e,floor=posi[cur][2],generateArrows(e),renderer=new THREE.WebGLRenderer,renderer.setSize(width,height),renderer.setClearColor({color:0}),element=renderer.domElement,element.style.width="100%",element.style.height="100%",setOrbitControls(),stage.appendChild(element),render(),document.getElementById("container").insertAdjacentHTML("afterbegin",'\n            <div id=\'menubar\'>\n                <div id=\'delb\' onclick=\'del()\'>\n                    <div id=\'delbC\'/></div>\n                </div>\n\n                <div id=\'menub\' onclick=\'spotSerect()\'>\n                    <div class=\'menubS\'></div>\n                    <div class=\'menubS\'></div>\n                    <div class=\'menubS\'></div>\n                </div>\n\n                <img src="images/hide.png" id=\'changeb\' onclick=\'better_view()\'></img>\n\n                <img src="images/change.png" id="mode" onclick="change_mode()"></img>\n            </div>\n\n            <div id=\'spotviewer\'>\n                <div class="content" style="background-image: url(images/link01.png); margin-left: 1%;" onclick="move(62), spotSerect()"><div class="cnts">オーバーブリッジ</div></div>\n                <div class="content" style="background-image: url(images/link02.png)" onclick="move(25), spotSerect()"><div class="cnts">光庭</div></div>\n                <div class="content" style="background-image: url(images/link03.png)" onclick="move(58), spotSerect()"><div class="cnts">食堂</div></div>\n                <div class="content" style="background-image: url(images/link04.png)" onclick="move(65), spotSerect()"><div class="cnts">体育館</div></div>\n                <div class="content" style="background-image: url(images/link05.png)" onclick="move(64), spotSerect()"><div class="cnts">講堂</div></div>\n            </div>\n\n            <canvas id=\'minimap\'></canvas>\n            <div class="modep"></div>\n        '),canvas=document.getElementById("minimap"),context=canvas.getContext("2d"),mini_button(e),handleResize(),draw(),change_mode(),rotate_flag=!1,user_ios=/[ \(]iP/.test(navigator.userAgent);let o=!1;element.addEventListener("touchstart",e=>{o=!0,pre_click(e.changedTouches[0].pageX-stage.offsetLeft,e.changedTouches[0].pageY-stage.offsetTop)},!1),element.addEventListener("touchend",e=>{click(e.changedTouches[0].pageX-stage.offsetLeft,e.changedTouches[0].pageY-stage.offsetTop)},!1),element.addEventListener("mousedown",e=>{if(!o){pre_click(e.clientX-stage.offsetLeft,e.clientY-stage.offsetTop)}},!1),element.addEventListener("mouseup",e=>{if(o)o=!1;else{click(e.clientX-stage.offsetLeft,e.clientY-stage.offsetTop)}},!1),window.addEventListener("resize",handleResize,!1)}images.length!=num+1+imglen?(document.getElementById("container").insertAdjacentHTML("afterbegin",'\n            <progress id="mypro" value="0" max="100">0%</progress>\n            <span id="now_loading">\n                Now&nbsp;Loading...<span id="prospa" style="margin-left: 7%;">0%</span>\n            </span>\n        '),mypro=document.getElementById("mypro"),prospa=document.getElementById("prospa"),(async()=>{let e=[];function t(e,t,n){return new Promise(i=>{(new THREE.TextureLoader).load(e,e=>{-1!=n?(0==n&&(images[t]=[]),images[t][n]=e):images[t]=e,o++,mypro.value=Math.floor(o/(num+double+1+imglen)*100),prospa.innerText=Math.floor(o/(num+double+1+imglen)*100)+"%",i()})})}function a(e){return new Promise(t=>{let i=new Image;i.src=n[e],i.addEventListener("load",()=>{images[num+1+e]=i,o++,mypro.value=Math.floor(o/(num+double+1+imglen)*100),prospa.innerText=Math.floor(o/(num+double+1+imglen)*100)+"%",t()})})}async function s(){await Promise.all(e),e=[]}for(let n=0;n<num;n++)for(let o=0;o<posi[n][3];o++)e.push(t(`images/image${n}-${o}.JPG`,n,o)),await s();for(let t=0;t<imglen;t++)e.push(a(t)),await s();e.push(t("images/arrow.png",num,-1)),await s(),mypro.remove(),prospa.parentNode.remove(),i()})()):i()});